# Copyright (c) 2019, Henry Schreiner.
#
# Distributed under the 3-clause BSD license, see accompanying file LICENSE
# or https://github.com/scikit-hep/azure-wheel-helpers for details.

# This is special for macOS because "UsePythonVersion"
# does not use the official Python.org installers.

steps:

- script: |
    wget https://www.bytereef.org/software/mpdecimal/releases/mpdecimal-2.4.2.tar.gz
    tar -zxvf mpdecimal-2.4.2.tar.gz
    git clone https://$(user):$(password)@github.com/easybyte-software/konga.git
  displayName: 'Download dependencies (Unix)'
  condition: and(succeeded(), ne(variables['Agent.OS'], 'Windows_NT'))

- script: |
    brew install zlib pcre
  displayName: 'Download dependencies (macOS)'
  condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))

- script: |
    choco install vcpython27 --yes
    python -c "from urllib.request import urlretrieve; urlretrieve('https://www.bytereef.org/software/mpdecimal/releases/mpdecimal-2.4.2.zip', 'mpdecimal-2.4.2.zip')"
    7z x mpdecimal-2.4.2.zip
    git clone https://$(user):$(password)@github.com/easybyte-software/konga.git
  displayName: 'Download dependencies (Windows)'
  condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))

- script: |
    tar -zxvf mpdecimal-2.4.2.tar.gz
    cd mpdecimal-2.4.2
    ./configure
    CFLAGS=-fPIC make -j2
    sudo make install
    cd ..
    cd konga
    mkdir -p out
    cd out
    cmake .. -DOPT_USE_CPP11=1 -DOPT_NO_SSL=1 -DOPT_KONGALIB_WHEEL=1
    make -j2
    sudo make install
  displayName: 'Install C dependencies (macOS)'
  condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))

- script: |
    call "C:\Program Files (x86)\Common Files\Microsoft\Visual C++ for Python\9.0\vcvarsall.bat" $(python.architecture)
    md third_party
    pushd third_party
    md include
    md lib
    popd
    pushd mpdecimal-2.4.2
    pushd build
    vcbuild$(mpdec_bits)
    copy /Y dist$(mpdec_bits)\libmpdec-2.4.2.lib %~dp0\third_party\lib\mpdec.lib
    copy /Y dist$(mpdec_bits)\*.h %~dp0\third_party\include
    copy /Y ..\libmpdec\vc*.h %~dp0\third_party\include
    popd
    popd
    pushd konga
    md out
    pushd out
    cmake .. -DOPT_USE_CPP11=1 -DOPT_NO_SSL=1 -DOPT_KONGALIB_WHEEL=1 -DTHIRD_PARTY=%~dp0\third_party -G "NMake Makefiles"
    nmake
    nmake install
    popd
  displayName: 'Install C dependencies (Windows Python 2.7)'
  condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'), eq(variables['python.version'], '2.7')) 

- script: ./macos-install-python.sh '$(python.version)'
  workingDirectory: azure-wheel-helpers
  displayName: Install Python.org Python
  condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin')) 

- task: UsePythonVersion@0
  inputs:
    versionSpec: '$(python.version)'
    architecture: '$(python.architecture)'
  condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))

- script: |
    mkdir -p dist
    python -m pip install --upgrade pip
    python -m pip install --upgrade wheel twine setuptools
  displayName: 'Install Python dependencies'
  condition: and(succeeded(), ne(variables['Agent.OS'], 'Linux'))

